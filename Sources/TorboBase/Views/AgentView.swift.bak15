// Copyright 2026 Perceptual Art LLC. All rights reserved.
// Licensed under Apache 2.0 — see LICENSE file.
// Torbo Base — Agents Panel
// Multi-agent management: list all agents, create new ones, edit personality/permissions per agent.
// SiD is the built-in default and cannot be deleted.
#if canImport(SwiftUI)
import SwiftUI

struct AgentsView: View {
    @EnvironmentObject private var state: AppState
    @State private var agents: [AgentConfig] = []
    @State private var selectedAgentID: String? = "sid"
    @State private var editConfig: AgentConfig = AgentConfig.newAgent(id: "sid", name: "SiD")
    @State private var isLoading = true
    @State private var showCreateSheet = false
    @State private var showDeleteConfirm = false
    @State private var showResetConfirm = false
    @State private var expandedCategories: Set<String> = []
    @State private var importError: String?
    @State private var showImportError = false

    // Create agent form
    @State private var newAgentName = ""
    @State private var newAgentRole = "AI assistant"
    @State private var newAgentPreset = "default"

    var body: some View {
        HStack(spacing: 0) {
            // MARK: - Agent List (Left)
            agentListPanel
                .frame(width: 240)

            Divider()
                .background(Color.white.opacity(0.06))

            // MARK: - Agent Detail (Right)
            if isLoading {
                ProgressView()
                    .frame(maxWidth: .infinity, maxHeight: .infinity)
            } else {
                agentDetailPanel
                    .frame(maxWidth: .infinity)
            }
        }
        .task { await loadAgents() }
        .sheet(isPresented: $showCreateSheet) { createAgentSheet }
        .alert("Delete Agent?", isPresented: $showDeleteConfirm) {
            Button("Delete", role: .destructive) { Task { await deleteSelectedAgent() } }
            Button("Cancel", role: .cancel) {}
        } message: {
            Text("This will permanently delete \"\(editConfig.name)\" and all its settings.")
        }
        .alert("Reset to Defaults?", isPresented: $showResetConfirm) {
            Button("Reset", role: .destructive) { Task { await resetSelectedAgent() } }
            Button("Cancel", role: .cancel) {}
        } message: {
            Text("This will reset all customization for \"\(editConfig.name)\" to defaults.")
        }
        .alert("Import Failed", isPresented: $showImportError) {
            Button("OK", role: .cancel) {}
        } message: {
            Text(importError ?? "Unknown error")
        }
    }

    // MARK: - Agent List Panel

    private var agentListPanel: some View {
        VStack(spacing: 0) {
            // Header
            HStack {
                Text("AGENTS")
                    .font(.system(size: 11, weight: .bold, design: .monospaced))
                    .foregroundStyle(.white.opacity(0.4))
                    .tracking(1)
                Spacer()
                Text("\(agents.count)")
                    .font(.system(size: 10, weight: .medium, design: .monospaced))
                    .foregroundStyle(.white.opacity(0.2))
                    .padding(.horizontal, 6)
                    .padding(.vertical, 2)
                    .background(Color.white.opacity(0.04))
                    .clipShape(RoundedRectangle(cornerRadius: 4))
            }
            .padding(.horizontal, 16)
            .padding(.top, 20)
            .padding(.bottom, 12)

            // Agent list
            ScrollView {
                LazyVStack(spacing: 2) {
                    ForEach(agents) { agent in
                        agentRow(agent)
                    }
                }
                .padding(.horizontal, 8)
            }

            Divider().background(Color.white.opacity(0.06))

            // Create + Import buttons
            HStack(spacing: 0) {
                Button {
                    showCreateSheet = true
                } label: {
                    HStack(spacing: 6) {
                        Image(systemName: "plus.circle.fill")
                            .font(.system(size: 12))
                        Text("Create")
                            .font(.system(size: 11, weight: .medium))
                    }
                    .foregroundStyle(.cyan)
                    .frame(maxWidth: .infinity)
                    .padding(.vertical, 10)
                }
                .buttonStyle(.plain)

                Divider().frame(height: 20).background(Color.white.opacity(0.06))

                Button {
                    importAgent()
                } label: {
                    HStack(spacing: 6) {
                        Image(systemName: "square.and.arrow.down")
                            .font(.system(size: 12))
                        Text("Import")
                            .font(.system(size: 11, weight: .medium))
                    }
                    .foregroundStyle(.cyan)
                    .frame(maxWidth: .infinity)
                    .padding(.vertical, 10)
                }
                .buttonStyle(.plain)
            }
        }
        .background(Color.black.opacity(0.2))
    }

    private func agentRow(_ agent: AgentConfig) -> some View {
        let isSelected = selectedAgentID == agent.id
        return Button {
            selectedAgentID = agent.id
            editConfig = agent
        } label: {
            HStack(spacing: 10) {
                // Avatar circle
                ZStack {
                    Circle()
                        .fill(isSelected ? Color.cyan.opacity(0.2) : Color.white.opacity(0.06))
                    Text(String(agent.name.prefix(1)).uppercased())
                        .font(.system(size: 12, weight: .bold, design: .monospaced))
                        .foregroundStyle(isSelected ? .cyan : .white.opacity(0.5))
                }
                .frame(width: 32, height: 32)

                VStack(alignment: .leading, spacing: 2) {
                    HStack(spacing: 6) {
                        Text(agent.name)
                            .font(.system(size: 13, weight: isSelected ? .bold : .medium))
                            .foregroundStyle(isSelected ? .white : .white.opacity(0.7))
                        if agent.isBuiltIn {
                            Text("BUILT-IN")
                                .font(.system(size: 7, weight: .bold, design: .monospaced))
                                .foregroundStyle(.cyan.opacity(0.6))
                                .padding(.horizontal, 4)
                                .padding(.vertical, 1)
                                .background(Color.cyan.opacity(0.1))
                                .clipShape(RoundedRectangle(cornerRadius: 3))
                        }
                    }
                    Text(agent.role.isEmpty ? "Agent" : agent.role)
                        .font(.system(size: 10))
                        .foregroundStyle(.white.opacity(0.3))
                        .lineLimit(1)
                }

                Spacer()

                // Access level badge
                let levelNames = ["OFF", "CHAT", "READ", "WRITE", "EXEC", "FULL"]
                let lvl = min(agent.accessLevel, 5)
                Text(levelNames[lvl])
                    .font(.system(size: 8, weight: .bold, design: .monospaced))
                    .foregroundStyle(AccessLevel(rawValue: lvl)?.color ?? .gray)
                    .padding(.horizontal, 4)
                    .padding(.vertical, 2)
                    .background((AccessLevel(rawValue: lvl)?.color ?? .gray).opacity(0.1))
                    .clipShape(RoundedRectangle(cornerRadius: 3))
            }
            .padding(.horizontal, 10)
            .padding(.vertical, 8)
            .background(isSelected ? Color.white.opacity(0.06) : Color.clear)
            .clipShape(RoundedRectangle(cornerRadius: 8))
        }
        .buttonStyle(.plain)
    }

    // MARK: - Agent Detail Panel

    private var agentDetailPanel: some View {
        ScrollView {
            VStack(alignment: .leading, spacing: 0) {
                // Header
                HStack(alignment: .center) {
                    VStack(alignment: .leading, spacing: 4) {
                        Text(editConfig.name)
                            .font(.system(size: 24, weight: .bold))
                            .foregroundStyle(.white)
                        Text(editConfig.isBuiltIn ? "Built-in agent — cannot be deleted" : "Custom agent — id: \(editConfig.id)")
                            .font(.system(size: 13))
                            .foregroundStyle(.white.opacity(0.4))
                    }
                    Spacer()
                    HStack(spacing: 8) {
                        Button("Export") { exportSelectedAgent() }
                            .buttonStyle(.plain)
                            .font(.system(size: 11, weight: .medium))
                            .foregroundStyle(.cyan.opacity(0.6))
                            .padding(.horizontal, 12)
                            .padding(.vertical, 6)
                            .background(Color.cyan.opacity(0.06))
                            .clipShape(RoundedRectangle(cornerRadius: 6))

                        Button("Reset") { showResetConfirm = true }
                            .buttonStyle(.plain)
                            .font(.system(size: 11, weight: .medium))
                            .foregroundStyle(.white.opacity(0.3))
                            .padding(.horizontal, 12)
                            .padding(.vertical, 6)
                            .background(Color.white.opacity(0.04))
                            .clipShape(RoundedRectangle(cornerRadius: 6))

                        if !editConfig.isBuiltIn {
                            Button("Delete") { showDeleteConfirm = true }
                                .buttonStyle(.plain)
                                .font(.system(size: 11, weight: .medium))
                                .foregroundStyle(.red.opacity(0.6))
                                .padding(.horizontal, 12)
                                .padding(.vertical, 6)
                                .background(Color.red.opacity(0.06))
                                .clipShape(RoundedRectangle(cornerRadius: 6))
                        }
                    }
                }
                .padding(.horizontal, 32)
                .padding(.top, 32)
                .padding(.bottom, 24)

                VStack(spacing: 24) {
                    // MARK: - Permissions Section
                    sectionCard(title: "Permissions", icon: "lock.shield") {
                        fieldRow(label: "Access Level") {
                            Picker("", selection: $editConfig.accessLevel) {
                                Text("OFF (0)").tag(0)
                                Text("CHAT (1)").tag(1)
                                Text("READ (2)").tag(2)
                                Text("WRITE (3)").tag(3)
                                Text("EXEC (4)").tag(4)
                                Text("FULL (5)").tag(5)
                            }
                            .pickerStyle(.segmented)
                        }
                        fieldRow(label: "Directory Scopes (one per line, empty = unrestricted)") {
                            TextEditor(text: Binding(
                                get: { editConfig.directoryScopes.joined(separator: "\n") },
                                set: { editConfig.directoryScopes = $0.components(separatedBy: "\n").filter { !$0.trimmingCharacters(in: .whitespaces).isEmpty } }
                            ))
                                .font(.system(size: 13, design: .monospaced))
                                .scrollContentBackground(.hidden)
                                .frame(minHeight: 40)
                                .padding(8)
                                .background(Color.white.opacity(0.04))
                                .clipShape(RoundedRectangle(cornerRadius: 6))
                        }
                    }

                    // MARK: - Capabilities Section
                    sectionCard(title: "Capabilities", icon: "cpu") {
                        let agentLevel = AccessLevel(rawValue: editConfig.accessLevel) ?? .chatOnly
                        let globalCaps = AppState.shared.globalCapabilities
                        ForEach(CapabilityCategory.allCases, id: \.self) { category in
                            let tools = CapabilityRegistry.byCategory[category] ?? []
                            let availableTools = tools.filter { tool in
                                agentLevel.rawValue >= tool.minimumAccessLevel.rawValue
                            }
                            #if !os(macOS)
                            let platformTools = availableTools.filter { !$0.macOnly }
                            #else
                            let platformTools = availableTools
                            #endif
                            if !platformTools.isEmpty {
                                let isGloballyDisabled = globalCaps[category.rawValue] == false
                                let isExpanded = expandedCategories.contains(category.rawValue)
                                VStack(alignment: .leading, spacing: 0) {
                                    HStack(spacing: 10) {
                                        Image(systemName: isExpanded ? "chevron.down" : "chevron.right")
                                            .font(.system(size: 9, weight: .bold))
                                            .foregroundStyle(.white.opacity(0.3))
                                            .frame(width: 12)
                                        Image(systemName: category.icon)
                                            .font(.system(size: 13))
                                            .foregroundStyle(isGloballyDisabled ? .red.opacity(0.5) : .cyan)
                                            .frame(width: 20)
                                        VStack(alignment: .leading, spacing: 2) {
                                            Text(category.label)
                                                .font(.system(size: 13, weight: .medium))
                                                .foregroundStyle(.white.opacity(isGloballyDisabled ? 0.3 : 0.9))
                                            Text("\(platformTools.count) tool\(platformTools.count == 1 ? "" : "s")\(isGloballyDisabled ? " · Globally disabled" : "")")
                                                .font(.system(size: 10, design: .monospaced))
                                                .foregroundStyle(.white.opacity(0.3))
                                        }
                                        Spacer()
                                        if isGloballyDisabled {
                                            Image(systemName: "lock.fill")
                                                .font(.system(size: 10))
                                                .foregroundStyle(.red.opacity(0.5))
                                        } else {
                                            Toggle("", isOn: Binding(
                                                get: { editConfig.enabledCapabilities[category.rawValue] != false },
                                                set: { enabled in
                                                    if enabled {
                                                        editConfig.enabledCapabilities.removeValue(forKey: category.rawValue)
                                                    } else {
                                                        editConfig.enabledCapabilities[category.rawValue] = false
                                                    }
                                                }
                                            ))
                                            .toggleStyle(.switch)
                                            .labelsHidden()
                                            .scaleEffect(0.8)
                                            .tint(.cyan)
                                        }
                                    }
                                    .padding(.vertical, 4)
                                    .contentShape(Rectangle())
                                    .onTapGesture {
                                        withAnimation(.easeInOut(duration: 0.15)) {
                                            if isExpanded {
                                                expandedCategories.remove(category.rawValue)
                                            } else {
                                                expandedCategories.insert(category.rawValue)
                                            }
                                        }
                                    }
                                    // Expanded tool detail list
                                    if isExpanded {
                                        VStack(alignment: .leading, spacing: 3) {
                                            ForEach(platformTools, id: \.toolName) { tool in
                                                HStack(spacing: 8) {
                                                    Text(tool.toolName)
                                                        .font(.system(size: 11, weight: .medium, design: .monospaced))
                                                        .foregroundStyle(.cyan.opacity(0.7))
                                                    Text("—")
                                                        .font(.system(size: 10))
                                                        .foregroundStyle(.white.opacity(0.15))
                                                    Text(tool.description)
                                                        .font(.system(size: 10))
                                                        .foregroundStyle(.white.opacity(0.4))
                                                    Spacer()
                                                }
                                            }
                                        }
                                        .padding(.leading, 44)
                                        .padding(.vertical, 4)
                                        .transition(.opacity)
                                    }
                                }
                            }
                        }
                        HStack(spacing: 6) {
                            Image(systemName: "info.circle")
                                .font(.system(size: 10))
                                .foregroundStyle(.white.opacity(0.2))
                            Text("Click a category to see its tools. Toggle to enable/disable.")
                                .font(.system(size: 10))
                                .foregroundStyle(.white.opacity(0.2))
                        }
                        .padding(.top, 4)
                    }

                    // MARK: - Identity Section
                    sectionCard(title: "Identity", icon: "person.crop.circle") {
                        fieldRow(label: "Name") {
                            TextField("Agent name", text: $editConfig.name)
                                .textFieldStyle(.plain)
                                .font(.system(size: 14))
                                .padding(8)
                                .background(Color.white.opacity(0.04))
                                .clipShape(RoundedRectangle(cornerRadius: 6))
                        }
                        fieldRow(label: "Pronouns") {
                            Picker("", selection: $editConfig.pronouns) {
                                Text("she/her").tag("she/her")
                                Text("he/him").tag("he/him")
                                Text("they/them").tag("they/them")
                            }
                            .pickerStyle(.segmented)
                            .frame(maxWidth: 300)
                        }
                        fieldRow(label: "Role") {
                            TextField("AI assistant, Senior engineer, Research partner...", text: $editConfig.role)
                                .textFieldStyle(.plain)
                                .font(.system(size: 14))
                                .padding(8)
                                .background(Color.white.opacity(0.04))
                                .clipShape(RoundedRectangle(cornerRadius: 6))
                        }
                    }

                    // MARK: - Personality Section
                    sectionCard(title: "Personality", icon: "theatermasks") {
                        HStack(spacing: 8) {
                            ForEach(AgentConfig.presets, id: \.id) { preset in
                                Button(preset.label) {
                                    editConfig.voiceTone = preset.voiceTone
                                    editConfig.coreValues = preset.coreValues
                                    editConfig.personalityPreset = preset.id
                                }
                                .buttonStyle(.plain)
                                .font(.system(size: 11, weight: editConfig.personalityPreset == preset.id ? .bold : .medium))
                                .foregroundStyle(editConfig.personalityPreset == preset.id ? .black : .white.opacity(0.5))
                                .padding(.horizontal, 10)
                                .padding(.vertical, 5)
                                .background(editConfig.personalityPreset == preset.id ? Color.cyan : Color.white.opacity(0.04))
                                .clipShape(RoundedRectangle(cornerRadius: 6))
                            }
                        }
                        .padding(.bottom, 8)

                        fieldRow(label: "Voice & Tone") {
                            TextEditor(text: $editConfig.voiceTone)
                                .font(.system(size: 13))
                                .scrollContentBackground(.hidden)
                                .frame(minHeight: 60)
                                .padding(8)
                                .background(Color.white.opacity(0.04))
                                .clipShape(RoundedRectangle(cornerRadius: 6))
                        }
                    }

                    // MARK: - Values & Boundaries
                    sectionCard(title: "Values & Boundaries", icon: "shield.lefthalf.filled") {
                        fieldRow(label: "Core Values") {
                            TextEditor(text: $editConfig.coreValues)
                                .font(.system(size: 13))
                                .scrollContentBackground(.hidden)
                                .frame(minHeight: 60)
                                .padding(8)
                                .background(Color.white.opacity(0.04))
                                .clipShape(RoundedRectangle(cornerRadius: 6))
                        }
                        fieldRow(label: "Topics to Avoid") {
                            TextEditor(text: $editConfig.topicsToAvoid)
                                .font(.system(size: 13))
                                .scrollContentBackground(.hidden)
                                .frame(minHeight: 40)
                                .padding(8)
                                .background(Color.white.opacity(0.04))
                                .clipShape(RoundedRectangle(cornerRadius: 6))
                        }
                        fieldRow(label: "Custom Instructions") {
                            TextEditor(text: $editConfig.customInstructions)
                                .font(.system(size: 13))
                                .scrollContentBackground(.hidden)
                                .frame(minHeight: 60)
                                .padding(8)
                                .background(Color.white.opacity(0.04))
                                .clipShape(RoundedRectangle(cornerRadius: 6))
                        }
                    }

                    // MARK: - Knowledge & Context
                    sectionCard(title: "Knowledge & Context", icon: "brain") {
                        fieldRow(label: "Background Knowledge") {
                            TextEditor(text: $editConfig.backgroundKnowledge)
                                .font(.system(size: 13))
                                .scrollContentBackground(.hidden)
                                .frame(minHeight: 80)
                                .padding(8)
                                .background(Color.white.opacity(0.04))
                                .clipShape(RoundedRectangle(cornerRadius: 6))
                        }
                    }

                    // MARK: - Voice (TTS)
                    sectionCard(title: "Voice", icon: "waveform") {
                        fieldRow(label: "ElevenLabs Voice ID") {
                            TextField("Voice ID or leave empty", text: $editConfig.elevenLabsVoiceID)
                                .textFieldStyle(.plain)
                                .font(.system(size: 14))
                                .padding(8)
                                .background(Color.white.opacity(0.04))
                                .clipShape(RoundedRectangle(cornerRadius: 6))
                        }
                        fieldRow(label: "Fallback TTS Voice") {
                            Picker("", selection: $editConfig.fallbackTTSVoice) {
                                Text("alloy").tag("alloy")
                                Text("echo").tag("echo")
                                Text("fable").tag("fable")
                                Text("onyx").tag("onyx")
                                Text("nova").tag("nova")
                                Text("shimmer").tag("shimmer")
                            }
                            .pickerStyle(.segmented)
                            .frame(maxWidth: 400)
                        }
                    }

                    // Save button
                    HStack {
                        Spacer()
                        Button("Save Changes") {
                            Task { await saveConfig() }
                        }
                        .buttonStyle(.plain)
                        .font(.system(size: 13, weight: .bold))
                        .foregroundStyle(.black)
                        .padding(.horizontal, 24)
                        .padding(.vertical, 10)
                        .background(Color.cyan)
                        .clipShape(RoundedRectangle(cornerRadius: 8))
                    }
                    .padding(.top, 8)
                }
                .padding(.horizontal, 32)
                .padding(.bottom, 32)
            }
        }
    }

    // MARK: - Create Agent Sheet

    private var createAgentSheet: some View {
        VStack(spacing: 20) {
            Text("Create Agent")
                .font(.system(size: 18, weight: .bold))
                .foregroundStyle(.white)

            VStack(alignment: .leading, spacing: 12) {
                fieldRow(label: "Name") {
                    TextField("e.g. Rex, Nova, Atlas...", text: $newAgentName)
                        .textFieldStyle(.plain)
                        .font(.system(size: 14))
                        .padding(8)
                        .background(Color.white.opacity(0.04))
                        .clipShape(RoundedRectangle(cornerRadius: 6))
                }
                fieldRow(label: "Role") {
                    TextField("AI assistant, Code reviewer, Writing partner...", text: $newAgentRole)
                        .textFieldStyle(.plain)
                        .font(.system(size: 14))
                        .padding(8)
                        .background(Color.white.opacity(0.04))
                        .clipShape(RoundedRectangle(cornerRadius: 6))
                }
                fieldRow(label: "Personality") {
                    Picker("", selection: $newAgentPreset) {
                        ForEach(AgentConfig.presets, id: \.id) { preset in
                            Text(preset.label).tag(preset.id)
                        }
                    }
                    .pickerStyle(.segmented)
                }

                Text("Default access level: CHAT (1). You can change this after creation.")
                    .font(.system(size: 11))
                    .foregroundStyle(.white.opacity(0.3))
            }

            HStack(spacing: 12) {
                Button("Cancel") { showCreateSheet = false }
                    .buttonStyle(.plain)
                    .font(.system(size: 13, weight: .medium))
                    .foregroundStyle(.white.opacity(0.5))
                    .padding(.horizontal, 20)
                    .padding(.vertical, 8)
                    .background(Color.white.opacity(0.04))
                    .clipShape(RoundedRectangle(cornerRadius: 6))

                Button("Create") { Task { await createAgent() } }
                    .buttonStyle(.plain)
                    .font(.system(size: 13, weight: .bold))
                    .foregroundStyle(.black)
                    .padding(.horizontal, 20)
                    .padding(.vertical, 8)
                    .background(newAgentName.trimmingCharacters(in: .whitespaces).isEmpty ? Color.gray : Color.cyan)
                    .clipShape(RoundedRectangle(cornerRadius: 6))
                    .disabled(newAgentName.trimmingCharacters(in: .whitespaces).isEmpty)
            }
        }
        .padding(32)
        .frame(width: 420)
        .background(Color(white: 0.1))
    }

    // MARK: - Data Operations

    private func loadAgents() async {
        agents = await AgentConfigManager.shared.listAgents()
        if let first = agents.first(where: { $0.id == selectedAgentID }) ?? agents.first {
            selectedAgentID = first.id
            editConfig = first
        }
        isLoading = false
    }

    private func saveConfig() async {
        await AgentConfigManager.shared.updateAgent(editConfig)
        await MainActor.run { state.refreshAgentLevels() }
        await loadAgents()
    }

    private func createAgent() async {
        let name = newAgentName.trimmingCharacters(in: .whitespaces)
        guard !name.isEmpty else { return }
        let id = AgentConfig.slugify(name)

        var config = AgentConfig.newAgent(id: id, name: name, role: newAgentRole)
        // Apply selected preset
        if let preset = AgentConfig.presets.first(where: { $0.id == newAgentPreset }) {
            config.voiceTone = preset.voiceTone
            config.coreValues = preset.coreValues
            config.personalityPreset = preset.id
        }

        do {
            try await AgentConfigManager.shared.createAgent(config)
            await MainActor.run { state.refreshAgentLevels() }
            selectedAgentID = id
            editConfig = config
            newAgentName = ""
            newAgentRole = "AI assistant"
            newAgentPreset = "default"
            showCreateSheet = false
            await loadAgents()
        } catch {
            TorboLog.error("Create failed: \(error.localizedDescription)", subsystem: "AgentView")
        }
    }

    private func deleteSelectedAgent() async {
        guard let id = selectedAgentID else { return }
        do {
            try await AgentConfigManager.shared.deleteAgent(id)
            await MainActor.run { state.refreshAgentLevels() }
            selectedAgentID = "sid"
            await loadAgents()
        } catch {
            TorboLog.error("Delete failed: \(error.localizedDescription)", subsystem: "AgentView")
        }
    }

    private func resetSelectedAgent() async {
        guard let id = selectedAgentID else { return }
        await AgentConfigManager.shared.resetAgent(id)
        await loadAgents()
    }

    private func importAgent() {
        let panel = NSOpenPanel()
        panel.title = "Import Agent"
        panel.allowedContentTypes = [.json]
        panel.allowsMultipleSelection = false
        panel.canChooseDirectories = false
        guard panel.runModal() == .OK, let url = panel.url else { return }
        Task {
            do {
                let data = try Data(contentsOf: url)
                let success = await AgentConfigManager.shared.importAgent(data)
                if success {
                    await MainActor.run { state.refreshAgentLevels() }
                    await loadAgents()
                } else {
                    await MainActor.run {
                        importError = "Invalid agent config format"
                        showImportError = true
                    }
                }
            } catch {
                await MainActor.run {
                    importError = error.localizedDescription
                    showImportError = true
                }
            }
        }
    }

    private func exportSelectedAgent() {
        guard let id = selectedAgentID else { return }
        Task {
            guard let data = await AgentConfigManager.shared.exportAgent(id) else { return }
            await MainActor.run {
                let panel = NSSavePanel()
                panel.title = "Export Agent"
                panel.nameFieldStringValue = "\(id).json"
                panel.allowedContentTypes = [.json]
                guard panel.runModal() == .OK, let url = panel.url else { return }
                try? data.write(to: url, options: .atomic)
            }
        }
    }

    // MARK: - UI Helpers

    @ViewBuilder
    private func sectionCard(title: String, icon: String, @ViewBuilder content: () -> some View) -> some View {
        VStack(alignment: .leading, spacing: 12) {
            HStack(spacing: 8) {
                Image(systemName: icon)
                    .font(.system(size: 12))
                    .foregroundStyle(.cyan)
                Text(title.uppercased())
                    .font(.system(size: 12, weight: .bold, design: .monospaced))
                    .foregroundStyle(.cyan)
                    .tracking(1)
            }
            .padding(.bottom, 4)

            content()
        }
        .padding(20)
        .background(Color.white.opacity(0.02))
        .clipShape(RoundedRectangle(cornerRadius: 10))
        .overlay(
            RoundedRectangle(cornerRadius: 10)
                .stroke(Color.white.opacity(0.06), lineWidth: 1)
        )
    }

    @ViewBuilder
    private func fieldRow(label: String, @ViewBuilder content: () -> some View) -> some View {
        VStack(alignment: .leading, spacing: 6) {
            Text(label)
                .font(.system(size: 11, weight: .medium, design: .monospaced))
                .foregroundStyle(.white.opacity(0.4))
                .textCase(.uppercase)
                .tracking(0.5)
            content()
        }
    }
}
#endif
